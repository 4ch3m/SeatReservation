<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>강의실 좌석 예약 현황</title>
	<link rel="stylesheet" href="/css/classroomStyle.css" />
	<link rel="stylesheet" href="/css/classroomStatusStyle.css" />
	<link rel="stylesheet" href="/css/reserveSeatStyle.css" />
	<link rel="stylesheet" href="/css/timeTableStyle.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
	<header th:if="${userPosition == 'student'}">
		<header th:replace="~{/menu.html}"></header> <!-- 메뉴 포함 -->
	</header>
	<header th:if="${userPosition == 'admin'}">
		<header th:replace="~{/menu_admin.html}"></header> <!-- 메뉴 포함 -->
	</header>
	<header th:if="${userPosition == 'professor'}">
		<header th:replace="~{/menu_admin.html}"></header> <!-- 메뉴 포함 -->
	</header>

	<!-- 좌석 예약 현황 모달 -->
	<div id="seatModal" class="seatModal" th:if="${classroom}">
		<div class="modal-content">
			<span class="close" id="closeSeatModal">&times;</span>
			<h1 th:if="${classroom}" th:text="${classroom.classroomName} + '호 좌석 예약 현황'">강의실 좌석 예약 현황</h1>
			<div class="grid-container">
				<div class="grid">
					<div class="seat-layout">
						<div class="left-seats"></div>
						<div class="right-seats"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 모달 -->
	<div id="myModal" class="modal">
		<div class="modal-content">
			<span class="close" id="closeModal">&times;</span>
			<p id="modalMessage">좌석을 예약하시겠습니까?</p>
			<button id="confirmButton">예</button>
			<button id="cancelButton">아니오</button>
		</div>
	</div>

	<!-- GET 방식일 때만 예약된 좌석 정보 표시 -->
	<div th:if="${requestMethod == 'GET'}">
		<div th:if="${userPosition == 'student'}">
			<div id="seatListModal" class="seatListModal">
				<div class="modal-content">
					<span class="close" id="closeSeatListModal">&times;</span>
					<h1>예약된 좌석</h1>
					<table>
						<thead>
							<tr>
								<th>과목</th>
								<th>강의실</th>
								<th>좌석 번호</th>
								<th>요일</th>
								<th>시간대</th>
								<th>예약 번호</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td th:text="${classroom.subject}"></td>
								<td th:text="${classroom.classroomName} + '호'"></td>
								<td th:text="${classroom.seatNumber} + '번 좌석'"></td>
								<td th:text="${classroom.day}"></td>
								<td th:text="${selectHours} + '시'"></td>
								<td th:text="${classroom.randomNum} + '번'"></td>
							</tr>
						</tbody>
					</table>
					<!-- 버튼을 가운데 정렬하고 가로로 배치 -->
					<div style="display: flex; justify-content: center;">
						<button type="button" onclick="location.href='/reserveList'"
							style="width: 8.5rem; height: 3.2rem; font-size: 1rem; margin-right: 0.6rem;">
							전체 내용 보기
						</button>
						<button type="button" onclick="closeSeatListModal()"
							style="width: 8.5rem; height: 3.2rem; font-size: 1rem;">
							닫기
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- GET 방식일 때만 예약된 좌석 정보 표시 -->
	<div th:if="${requestMethod == 'GET'}">
		<div th:if="${userPosition == 'admin' or userPosition == 'professor'}">
			<div id="seatListModal" class="seatListModal">
				<div class="modal-content">
					<h1>금지된 좌석</h1>
					<table>
						<thead>
							<tr>
								<th>과목</th>
								<th>강의실</th>
								<th>좌석 번호</th>
								<th>요일</th>
								<th>시간대</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td th:text="${banSeatDTO.subject}"></td>
								<td th:text="${banSeatDTO.classroomName} + '호'"></td>
								<td th:text="${banSeatDTO.seatNumber} + '번 좌석'"></td>
								<td th:text="${banSeatDTO.day}"></td>
								<td th:text="${selectHours} + '시'"></td>
							</tr>
						</tbody>
					</table>
					<!-- 버튼을 가운데 정렬하고 가로로 배치 -->
					<div style="display: flex; justify-content: center;">
						<button type="button" onclick="location.href='/reserveList'"
							style="width: 8.5rem; height: 3.2rem; font-size: 1rem; margin-right: 0.6rem;">
							전체 내용 보기
						</button>
						<button type="button" onclick="closeSeatListModal()"
							style="width: 8.5rem; height: 3.2rem; font-size: 1rem;">
							닫기
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<h1>시간표</h1>
	<!-- 시간표 컨테이너 -->
	<div class="container">
		<!-- 시간표 테이블 -->
		<table>
			<thead>
				<!-- 요일 헤더 -->
				<tr>
					<th></th>
					<!-- 요일별 반복 -->
					<th th:each="day : ${days}" th:text="${day}"></th>
				</tr>
			</thead>
			<tbody>
				<!-- 시간별 반복 -->
				<tr th:each="hour : ${hours}">
					<!-- 시간 표시 -->
					<td th:text="${hour}"></td>
					<!-- 요일별 시간표 -->
					<td th:each="day : ${days}" class="clickable" data-day="${day}" data-hour="${hour}">
						<div th:each="timeTable, stat : ${userTimeTable}"
							th:if="${timeTable.day == day and timeTable.startHour le hour and timeTable.endHour gt hour}"
							th:classappend="'subject-' + ${stat.index % 10}" th:attr="data-subject=${timeTable.subject}, data-classroom=${timeTable.classroomName}, 
	                                      data-day=${timeTable.day}, data-hour=${hour}">
							<!-- 시간표 정보 표시 -->
							<span th:text="${timeTable.subject + ' (' + timeTable.classroomName + ')'}"></span><br>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<script th:inline="javascript">
		let selectedSeat, selectedClassroom; // 선택된 좌석과 강의실 변수
		const userPosition = /*[[${userPosition}]]*/ 'default'; // 사용자 위치 (학생/교수 등)
		const classrooNull = /*[[${classroom.classroomNull}]]*/ 0; // 강의실 존재 여부
		const requestMethod = /*[[${requestMethod}]]*/ 'GET'; // 요청 방식 (GET/POST)

		// 모달 바깥 클릭 시 seatListModal 모달 닫기
		window.onclick = event => {
			if (event.target === document.getElementById('seatListModal')) closeSeatListModal();
		}

		// 강의실이 존재하지 않을 경우 seatListModal 모달 열기 및 seatModal 모달 닫기
		if (classrooNull == 0) {
			openSeatListModal(); // 예약 리스트 모달 열기
			document.getElementById('seatModal').style.display = 'none'; // 좌석 모달 숨기기
			closeSeatModal(); // 좌석 모달 닫기 함수 호출
		}

		// 예약 확인 모달 닫기
		function closeSeatListModal() {
			document.getElementById('seatListModal').style.display = 'none'; // 예약 리스트 모달 숨기기
			window.location.href = "/timetable"; // timetable 페이지로 이동
		}

		// 예약 확인 모달 열기
		function openSeatListModal() {
			document.getElementById('seatListModal').style.display = 'block'; // 예약 리스트 모달 표시
		}

		document.addEventListener('DOMContentLoaded', () => {
			const leftSeats = document.querySelector('.left-seats'); // 왼쪽 좌석 컨테이너
			const rightSeats = document.querySelector('.right-seats'); // 오른쪽 좌석 컨테이너
			let seatNumber = 1; // 좌석 번호 초기화

			// 좌석 상태를 Thymeleaf로부터 가져옴
			const seatStatusList = /*[[${reservedSeats}]]*/[]; // 예약된 좌석 번호 배열
			const bannedSeatsList = /*[[${banSeatDTO.bannedSeats}]]*/[]; // 금지된 좌석 번호 배열    

			// 좌석 상태 리스트 생성
			const totalSeats = /*[[${classroom.seatCount}]]*/ 0; // 총 좌석 수
			const seatArray = Array(totalSeats).fill(false); // 기본적으로 모든 좌석은 비어있음

			// 예약된 좌석 상태 업데이트
			if (seatStatusList != null) {
				seatStatusList.forEach(seat => {
					seatArray[seat - 1] = true; // 예약 상태 설정
				});
			}

			// 금지된 좌석 상태 업데이트
			if (bannedSeatsList != null) {
				bannedSeatsList.forEach(seat => {
					seatArray[seat - 1] = 'banned'; // 금지 상태 설정
				});
			}

			// GET 방식으로 접근할 경우 예약 리스트 모달 열기
			if (requestMethod == 'GET') {
				document.getElementById('seatListModal').style.display = 'block';
			}

			// 강의실이 비어있을 경우 좌석 모달 열기
			if (classrooNull == 1) {
				openSeatModal();
			}

			// 강의실이 존재하지 않을 경우 예약 리스트 모달 열기
			if (classrooNull == 0) {
				openSeatListModal(); // 모달 열기
			}

			const goBackHome = () => {
				window.location.href = '/'; // 홈으로 리다이렉션
			};

			// 현재 페이지 상태를 pushState로 추가
			window.history.pushState(null, "", window.location.pathname);
			// popstate 이벤트 리스너 추가 (뒤로가기 버튼 감지)
			window.addEventListener("popstate", goBackHome);
			// 페이지를 떠날 때 이벤트 리스너 제거
			window.addEventListener('beforeunload', () => {
				window.removeEventListener("popstate", goBackHome);
			});

			// 좌석 버튼 생성 함수
			function createSeatButton(number, classroomName) {
				const seatStatus = seatArray[number - 1]; // 좌석 상태 확인
				let seat = document.createElement('button'); // 좌석 버튼 생성

				// 좌석 상태에 따라 클래스 추가
				if (seatStatus === true) {
					seat.classList.add('seat', 'reserved'); // 예약된 좌석
				} else if (seatStatus === 'banned') {
					seat.classList.add('seat', 'banned'); // 금지된 좌석
					seat.disabled = true; // 클릭 비활성화
				} else {
					seat.classList.add('seat', 'empty'); // 빈 좌석
				}

				seat.textContent = number; // 좌석 번호 설정
				seat.dataset.seat = number; // 데이터 속성에 좌석 번호 저장
				seat.dataset.classroom = classroomName; // 데이터 속성에 강의실 이름 저장
				seat.onclick = () => openModal(seat); // 클릭 시 모달 열기
				return seat; // 생성된 좌석 버튼 반환
			}

			// 좌석 배치를 생성하는 함수
			function createSeatLayout(leftRows, leftCols, rightRows, rightCols, classroomName) {
				// 왼쪽 및 오른쪽 좌석 행 생성
				for (let i = 0; i < Math.max(leftRows, rightRows); i++) {
					let leftRow = document.createElement('div');
					leftRow.classList.add('seat-row'); // 왼쪽 좌석 행 클래스 추가
					let rightRow = document.createElement('div');
					rightRow.classList.add('seat-row'); // 오른쪽 좌석 행 클래스 추가

					// 왼쪽 좌석 버튼 추가
					for (let j = 0; j < leftCols; j++) {
						if (i < leftRows) {
							leftRow.appendChild(createSeatButton(seatNumber++, classroomName)); // 좌석 버튼 생성 및 추가
						}
					}

					// 오른쪽 좌석 버튼 추가
					for (let j = 0; j < rightCols; j++) {
						if (i < rightRows) {
							rightRow.appendChild(createSeatButton(seatNumber++, classroomName)); // 좌석 버튼 생성 및 추가
						}
					}

					leftSeats.appendChild(leftRow); // 왼쪽 좌석 추가
					rightSeats.appendChild(rightRow); // 오른쪽 좌석 추가
				}
			}

			const leftRows = /*[[${classroom.leftRow}]]*/ 2; // 왼쪽 행 수
			const leftCols = /*[[${classroom.leftCol}]]*/ 3; // 왼쪽 열 수
			const rightRows = /*[[${classroom.rightRow}]]*/ 2; // 오른쪽 행 수
			const rightCols = /*[[${classroom.rightCol}]]*/ 3; // 오른쪽 열 수
			const classroomName = /*[[${classroom.classroomName}]]*/ 'undefined'; // 강의실 이름

			createSeatLayout(leftRows, leftCols, rightRows, rightCols, classroomName); // 좌석 배치 생성 호출

			// 모달 닫기 함수
			function closeModal() {
				document.getElementById('myModal').style.display = 'none'; // 일반 모달 숨기기
			}

			// 좌석 모달 닫기 함수
			function closeSeatModal() {
				document.getElementById('seatModal').style.display = 'none'; // 좌석 모달 숨기기
				if (classrooNull == 1) { // 강의실이 비어있는 경우
					window.location.href = "/timetable"; // timetable으로 이동
				}
			}

			// 예약 확인 모달 닫기 함수
			function closeSeatListModal() {
				document.getElementById('seatListModal').style.display = 'none'; // 예약 리스트 모달 숨기기
			}

			// 좌석 모달 열기 함수
			function openSeatModal() {
				if (document.referrer.includes('/timetable')) { // 이전 페이지가 timetable인 경우
					document.getElementById('seatModal').style.display = 'block'; // 좌석 모달 표시
				}
			}

			// 좌석 리스트 모달 열기 함수
			function openSeatListModal() {
				document.getElementById('seatModal').style.display = 'block'; // 예약 리스트 모달 표시
			}

			// 좌석 클릭 시 모달 열기
			function openModal(button) {
				if (button.classList.contains('reserved')) { // 예약된 좌석 클릭 시
					Swal.fire('예약된 좌석입니다.', '', 'warning'); // 경고 메시지 표시
					return;
				}
				if (button.classList.contains('banned')) { // 금지된 좌석 클릭 시
					Swal.fire('예약할 수 없는 좌석입니다.', '', 'warning'); // 경고 메시지 표시
					return;
				}

				selectedSeat = button.dataset.seat; // 선택된 좌석 번호 저장
				selectedClassroom = button.dataset.classroom; // 선택된 강의실 이름 저장
				document.getElementById('myModal').style.display = 'block'; // 좌석 모달 열기
			}

			// 예약 확인 버튼 클릭 시 호출되는 함수
			document.getElementById('confirmButton').onclick = () => {
				// AJAX 요청을 보내 예약 처리
				fetch('/reserve', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify({seat: selectedSeat, classroom: selectedClassroom}) // 좌석 및 강의실 정보 전송
				}).then(response => {
					if (response.ok) {
						Swal.fire('예약이 완료되었습니다.', '', 'success'); // 성공 메시지 표시
						closeModal(); // 모달 닫기
						setTimeout(() => {
							window.location.reload(); // 페이지 새로고침
						}, 2000); // 2초 후 새로고침
					} else {
						Swal.fire('예약 실패. 다시 시도해주세요.', '', 'error'); // 오류 메시지 표시
					}
				}).catch(error => {
					console.error('Error:', error); // 오류 로그
					Swal.fire('예약 실패. 다시 시도해주세요.', '', 'error'); // 오류 메시지 표시
				});
			};
		});
	</script>
</body>

</html>