<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>로그인 및 시간표</title>
    <link rel="stylesheet" href="/css/loginStyle.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" /> <!-- Font Awesome -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- 헤더 시작 -->
    <header th:if="${userPosition == 'student'}">
		<header th:replace="~{/menu.html}"></header> <!-- 메뉴 포함 -->
	</header>
	<header th:if="${userPosition == 'admin'}">
		<header th:replace="~{/menu_admin.html}"></header> <!-- 메뉴 포함 -->
	</header>
	<header th:if="${userPosition == 'professor'}">
		<header th:replace="~{/menu_admin.html}"></header> <!-- 메뉴 포함 -->
	</header>
    <!-- 헤더 끝 -->

    <!-- 버튼으로 포지션 선택 -->
	<div class="button-container" th:if="${userPosition == 'admin' or userPosition == 'professor'}">
	    <a href="/classroomSet"><button><i class="fas fa-chair"></i></button></a> <!-- 강의실 템플릿 (좌석 아이콘) -->
	    <a href="/admin"><button><i class="fas fa-school"></i></button></a> <!-- 관리자 대시보드 (교실 아이콘) -->
	    <a href="/banList"><button><i class="fas fa-ban"></i></button></a> <!-- 예약 금지 좌석 확인 (금지 아이콘) -->
	    <a href="/myPage"><button><i class="fas fa-user"></i></button></a> <!-- 마이페이지 -->
	</div>
	<div class="button-container" th:unless="${userPosition == 'admin' or userPosition == 'professor'}">
	    <a href="/classroomLike"><button><i class="fas fa-star"></i></button></a> <!-- 강의실 현황 -->
	    <a href="/timetable"><button><i class="fas fa-calendar-alt"></i></button></a> <!-- 시간표 -->
	    <a href="/reserveList"><button><i class="fas fa-bell"></i></button></a> <!-- 예약확인 -->
	    <a href="/myPage"><button><i class="fas fa-user"></i></button></a> <!-- 마이페이지 -->
	</div>

<!-- 학생 계정일 때만 모달을 렌더링 -->
    <div th:if="${session.isStudent}">
<!-- 팝업창 구조 -->
    <div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>오늘의 시간표</h2>
        <div id="scheduleContent">
            <!-- AJAX로 불러온 오늘의 시간표가 표시될 부분 -->
        </div>
    </div>
</div>
    </div>
<!-- 에러 -->
	<div th:if="${error}" class="error" th:text="${error}"></div>

    <!-- 메인 컨텐츠 영역 -->
    <div class="main-container">
        <!-- 시간표 섹션 시작 -->
        <div class="timetable-section">
            <div class="container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th th:each="day : ${days}" th:text="${day}"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="hour : ${hours}">
                            <td th:text="${hour}"></td>
                            <td th:each="day : ${days}">
                                <span th:each="timeTable : ${userTimeTable}"
                                      th:if="${timeTable.day == day 
                                            and timeTable.startHour le hour
                                            and timeTable.endHour gt hour}">
                                    <span th:text="${timeTable.subject + ' (' + timeTable.classroomName + ')'}"></span><br>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 시간표 섹션 끝 -->

        <!-- 로그인 폼을 오른쪽에 배치 -->
        <div class="login-container">
            <div class="login-box">
                <h2>로그인</h2>

                <!-- 에러 메시지 -->
                <div th:if="${error}" class="error" th:text="${error}"></div>
				<!-- 로그인 전 폼 -->
				<form th:if="${session.loggedInUser == null}" action="/login" method="post">
				    <div>
				        <input type="text" id="id" name="id" placeholder="ID" required>
				    </div>
				    <div>
				        <input type="password" id="password" name="password" placeholder="Password" required>
				    </div>
				    
				    <br>
				    <div>
				        <input type="submit" value="로그인" class="btn">
				    </div>

				    <div class="selectPosition" style="margin-top: 10px;">
				        <a href="selectPosition">회원가입</a>
				    </div>
				</form>

				<!-- 로그인 후 정보 표시 -->
				<div th:if="${session.loggedInUser != null}">
				    <p>ID: <span th:text="${session.loggedInUser.id}"></span></p>
				    <p>이름: <span th:text="${session.loggedInUser.name}"></span></p>
				    <form action="/logout" method="get">
					<div>
						<input type="submit" value="로그아웃" class="btn">
					</div>
				    </form>
				</div>
            </div>
        </div>
    </div>
<script>
    // 팝업 열기 및 닫기 기능
    var modal = document.getElementById("myModal");
    var closeBtn = document.getElementsByClassName("close")[0];
    // 페이지 로드 시 모달 열기 (학생일 때만)
    window.onload = function() {
        if (document.getElementById("myModal")) {
            loadTodaySchedule(); // 오늘의 시간표를 불러오는 함수 호출
        }
    }


    // 닫기 버튼 클릭 시 팝업 닫기
    closeBtn.onclick = function() {
        modal.style.display = "none"; // 팝업창 닫기
    }

    // 팝업창 외부 클릭 시 팝업 닫기
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

   // AJAX 함수 수정
function loadTodaySchedule() {
    $.ajax({
        url: '/api/today-schedule',
        method: 'GET',
        success: function(data) {
            var scheduleContent = $('#scheduleContent');
            scheduleContent.empty();

            if (data.length === 0) {
                scheduleContent.append('<p>오늘의 시간표가 없습니다.</p>');
            } else {
                var table = '<table><thead><tr><th>과목</th><th>강의실</th><th>시작 시간</th><th>종료 시간</th><th>예약 상태</th><th>예약</th></tr></thead><tbody>';
                $.each(data, function(index, item) {
                    table += '<tr><td>' + item.subject + '</td><td>' + item.classroomName + '</td><td>' + item.startHour +"시"+ '</td><td>' + item.endHour +"시"+ '</td>';
                    table += '<td>' + item.reservationStatus + '</td>';
                    
                    // 예약 상태에 따라 예약번호 표시
                    if (item.reservationStatus === '예약완료' && item.reservationInfo) {
                        table += '<td>예약번호: ' + item.reservationInfo.reservNum + '</td>';
                    } else {
                        table += '<td><button onclick="reserveSeat(\'' + item.subject + '\', \'' + item.classroomName + '\', ' + item.startHour + ')">좌석 예약</button></td>';
                    }
                    
                    table += '</tr>';
                });
                table += '</tbody></table>';
                scheduleContent.append(table);
            }
        },
        error: function() {
            $('#scheduleContent').append('<p>시간표를 불러오는 중 오류가 발생했습니다.</p>');
        }
    });
}


    // 좌석 예약을 처리하는 함수 (임의로 설정된 함수, 실제 동작할 내용은 서버 구현에 따라 달라집니다.)
    function reserveSeat(subject, classroomName, startHour) {
        // 페이지 이동 처리
    window.location.href = '/timetable'; // timetable.html 페이지로 이동
    }





</script>

</body>
</html>
