<html xmlns="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>강의실 자리 예약 프로그램 학생 회원가입</title>
    <link rel="stylesheet" href="/css/classroomStyle.css" />
    <style>
        .autocomplete-list {
            position: absolute;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            z-index: 999;
            width: 100%;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
        }
    </style>
    <script>
        // 아이디 중복 확인 결과를 저장하는 변수
        let isIdChecked = false;

        // 학교 검색 필드 필터링 함수
        function filterSchools() {
            var input, filter, select, option, i;
            input = document.getElementById('schoolInput');
            filter = input.value.toUpperCase();
            select = document.getElementById('schoolList');
            option = select.getElementsByTagName('option');
            
            for (i = 0; i < option.length; i++) {
                txtValue = option[i].text;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    option[i].style.display = "";
                } else {
                    option[i].style.display = "none";
                }
            }
            select.style.display = "block";
        }

        // 선택된 학교를 입력 필드에 채우는 함수
        function fillSchool(value) {
            document.getElementById('schoolInput').value = value;
            document.getElementById('schoolList').style.display = "none";
        }

        // 폼 유효성 검사 함수
        function validateForm() {
            var selectedSchool = document.getElementById('schoolInput').value;
            var allowedSchools = ['대학교1', '대학교2', '대학교3'];
            var password = document.getElementById('pass').value;
            var confirmPassword = document.getElementById('confirmPass').value;

            // 등록된 학교가 아닌 경우 경고 메시지
            if (!allowedSchools.includes(selectedSchool)) {
                alert('등록되지 않은 학교입니다. 등록된 학교에서만 회원가입이 가능합니다.');
                return false;
            }

            // 비밀번호 유효성 검사
            if (!isValidPassword(password)) {
                alert('비밀번호는 최소 8자이며, 하나 이상의 문자 및 숫자를 포함해야 합니다.');
                return false;
            }

            // 비밀번호 확인 일치 여부 확인
            if (password !== confirmPassword) {
                alert('비밀번호가 일치하지 않습니다.');
                return false;
            }

            return true;
        }

        // 비밀번호 유효성을 검사하는 함수
        function isValidPassword(password) {
            var re = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
            return re.test(password);
        }

        // 아이디 중복 확인을 수행하는 함수
        function checkId() {
            var id = document.getElementById('id').value;
            if (id === "") {
                alert("아이디를 입력하세요.");
                return;
            }

            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/checkId?id=" + id, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var isExists = xhr.responseText === 'true';
                    var idErrorSpan = document.getElementById('idError');
                    if (isExists) {
                        idErrorSpan.textContent = "이미 사용 중인 아이디입니다.";
                        isIdChecked = false;
                    } else {
                        idErrorSpan.textContent = "사용 가능한 아이디입니다.";
                        isIdChecked = true;
                    }
                }
            };
            xhr.send();
        }

        // 폼 제출 시 호출되는 함수
        function handleFormSubmit(event) {
            // 아이디 중복 확인이 완료되지 않았을 경우 경고 메시지
            if (!isIdChecked) {
                alert('아이디 중복확인을 해주세요.');
                event.preventDefault();
                return;
            }

            // 폼 유효성 검사 함수 호출
            if (!validateForm()) {
                event.preventDefault();
                return;
            }

            // 모든 유효성 검사 통과 후 회원가입 완료 알림창
            alert('회원가입이 완료되었습니다.');
        }
    </script>
</head>
<body>
    <h2>강의실 자리 예약 프로그램 학생 회원가입</h2>
    <form id="studentSignupForm" action="/signupCheck" method="post" onsubmit="handleFormSubmit(event)">
        <div>
            <label for="id">사용자 아이디:</label>
            <input type="text" id="id" name="id" required>
            <button type="button" onclick="checkId()">아이디 중복확인</button>
            <span class="error-message" id="idError" th:text="${idError}"></span>
        </div>
        <div>
            <label for="pass">비밀번호:</label>
            <input type="password" id="pass" name="pass" required>
            <!-- 비밀번호 유효성 메시지 -->
            <span class="error-message">비밀번호는 최소 8자이며, 하나 이상의 문자 및 숫자를 포함해야 합니다.</span>
        </div>
        <div>
            <label for="confirmPass">비밀번호 확인:</label>
            <input type="password" id="confirmPass" name="confirmPass" required>
        </div>
        <div>
            <label for="schoolInput">학교:</label>
            <input type="text" id="schoolInput" name="school" onkeyup="filterSchools()" onclick="filterSchools()" placeholder="학교 검색" required>
            <div id="schoolList" class="autocomplete-list" style="display: none;">
                <option value="">학교 선택</option>
                <option value="대학교1" onclick="fillSchool('대학교1')">대학교1</option>
                <option value="대학교2" onclick="fillSchool('대학교2')">대학교2</option>
                <option value="대학교3" onclick="fillSchool('대학교3')">대학교3</option>
            </div>
        </div>
        <div>
            <label for="major">전공:</label>
            <input type="text" id="major" name="major" required>
        </div>
        <div>
            <label for="name">이름:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div>
            <label for="age">나이:</label>
            <input type="text" id="age" name="age" required>
        </div>
        <div>
            <label for="grade">학년:</label>
            <input type="text" id="grade" name="grade" required>
        </div>
        <div>
            <label for="classNumber">반:</label>
            <input type="text" id="classNumber" name="classNumber" required>
        </div>
        <div>
            <label for="studentId">학번:</label>
            <input type="text" id="studentId" name="studentId" required>
        </div>
        <button type="submit">가입완료하기</button>
    </form>
</body>
</html>